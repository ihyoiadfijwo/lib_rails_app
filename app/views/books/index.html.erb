<p style="color: green"><%= notice %></p>

<% content_for :title, "Books" %>

<h2 style="margin-left: 5%">Books</h2>

<div style="margin: 0 5%;">
  <div style="padding: 16px; border: 1px solid #ccc; border-radius: 8px; background: #f9f9f9;">
    <div style="margin-bottom: 24px; padding: 16px; border: 1px solid #ccc; border-radius: 8px; background: #f9f9f9; max-width: 600px;">
      <%= form_with url: books_path, method: :get, local: false do |form| %>
        <div style ="display: flex; align-items: center; gap: 12px;">
          <%= form.text_field :q, value: params[:q], placeholder: "タイトル・著者で検索", style: "flex: 2; padding: 8px; border-radius: 4px; border: 1px solid #ccc;" %>
          <%= form.select :category, options_for_select(@categories, params[:category]), include_blank: true, style: "flex: 1; padding: 8px; border-radius: 4px; border: 1px solid #ccc;" %>
          <%= form.submit "検索", style: "flex: 0; padding: 8px 16px; border-radius: 4px; background: #007bff; color: #fff; border: none;" %>
        </div>
      <% end %>
    </div>
  
    <div id="books_list">
      <%= render partial: "books_list", locals: { books: @books } %>
    </div>
  </div>
  
  <div id="borrowed_books_list">
    <%= render partial: "borrowed_books_list", locals: { loans: @borrowed_loans } %>
  </div>
</div>

<%= link_to "New book", new_book_path %>

<script>
document.querySelector('form').onsubmit = function(event) {
  event.preventDefault(); // フォームのデフォルト送信を防ぐ

  const formData = new FormData(event.target); // フォームデータを取得
  const query = formData.get('q'); // 検索ボックスの値
  const category = formData.get('category'); // プルダウンの値
  const token = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

  // Ajaxリクエストを送信
  fetch(`/books?q=${encodeURIComponent(query)}&category=${encodeURIComponent(category)}`, {
    headers: {
      'Accept': 'text/javascript',
      'X-CSRF-Token': token
    }
  })
    .then(res => res.text())
    .then(js => eval(js)); // サーバーから返されたJSを実行
};
</script>