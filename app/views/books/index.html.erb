<p style="color: green"><%= notice %></p>

<% content_for :title, "Books" %>

<h1>Books</h1>

<div style="display: flex; align-items: center; gap: 8px;">
  <%= form_with url: books_path, method: :get, local: false do |form| %>
    <div style ="display: flex; align-items: center; gap: 8px;">
      <%= form.text_field :q, value: params[:q], placeholder: "タイトル・著者で検索", style: "flex: 1;" %>
      <%= form.select :category, options_for_select(@categories, params[:category]), include_blank: true, style: "flex: 1;" %>
      <%= form.submit "検索", style: "flex: 0;" %>
    </div>
  <% end %>
</div>

<div id="books">
  <%= render partial: "books_list", locals: { books: @books } %>
</div>

<%= link_to "New book", new_book_path %>

<script>
document.querySelector('form').onsubmit = function(event) {
  event.preventDefault(); // フォームのデフォルト送信を防ぐ

  const formData = new FormData(event.target); // フォームデータを取得
  const query = formData.get('q'); // 検索ボックスの値
  const category = formData.get('category'); // プルダウンの値
  const token = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

  // Ajaxリクエストを送信
  fetch(`/books?q=${encodeURIComponent(query)}&category=${encodeURIComponent(category)}`, {
    headers: {
      'Accept': 'text/javascript',
      'X-CSRF-Token': token
    }
  })
    .then(res => res.text())
    .then(js => eval(js)); // サーバーから返されたJSを実行
};
</script>